<div class="container-body">
    <div class="shop-page">

        <!-- BREADCRUMBS -->
        <nav class="breadcrumbs">
            <span routerLink="/">Home</span>
            <span>/</span>
            <span routerLink="/stores">Stores</span>
            <span>/</span>
            <span class="active">{{ categoryName || 'Products' }}</span>
        </nav>

        <!-- CONTENT -->
        <div class="shop-layout">

            <!-- LEFT SIDEBAR : CATEGORIES -->
            <aside class="category-sidebar" [class.open]="showCategories">

                <!-- MOBILE HEADER -->
                <div class="sidebar-header mobile-only">
                    <h6>Categories</h6>
                    <button class="close-btn" (click)="showCategories = false">✕</button>
                </div>

                <ul class="category-list">
                    <li *ngFor="let category of categories"
                        (click)="onCategoryChange(category.slug); showCategories = false"
                        [class.active]="category.slug === categoryName">
                        <span>{{ category.name }}</span>
                        <small>{{ category.count }}</small>
                    </li>
                </ul>

            </aside>

            <!-- MAIN CONTENT -->
            <div class="shop-main">

                <!-- VENDOR STRIP -->
                <section class="vendor-strip" (scroll)="onStoresScroll($event)">
                    <div class="vendor-card" *ngFor="let store of stores" (click)="selectStore(store)"
                        [class.active]="store.id === selectedStoreId">

                        <div class="vendor-img-wrap">
                            <img [src]="store.shop_image || 'assets/images/no-image.jpg'" />

                            <div class="rating-badge"> <!-- *ngIf="store.rating"> -->
                                ⭐ {{ store.rating ?? 5 | number:'1.1-1' }}
                            </div>
                        </div>

                        <span [title]="store.name">{{ store.name }}</span>
                    </div>
                </section>




                <!-- PRODUCTS -->
                <section class="product-area" #productScroller (scroll)="onProductScroll()">
                    <!-- MOBILE CATEGORY TOGGLE -->
                    <button class="mobile-filter-btn" (click)="showCategories = true">
                        <i class="fas fa-list"></i>
                        Categories
                    </button>
                    <!-- LOADER -->
                    <div class="loader" *ngIf="isLoading">
                        <div class="spinner-border text-danger"></div>
                    </div>

                    <!-- PRODUCT GRID -->
                    <div class="product-grid" *ngIf="products.length; else noProducts">

                        <div class="product-card" *ngFor="let product of products"
                            [class.vendor-closed]="!product.shop?.is_accepting_orders">

                            <a [routerLink]="['/product', product.slug]">

                                <!-- DISCOUNT -->
                                <div *ngIf="product.discount_value > 0" class="discount">
                                    <ng-container *ngIf="product.discount_type === 'percentage'; else flatDiscount">
                                        {{ product.discount_value | number:'1.0-0'}}% OFF
                                    </ng-container>

                                    <ng-template #flatDiscount>
                                        ₹{{ product.discount_value | number:'1.0-0'}} OFF
                                    </ng-template>
                                </div>


                                <!-- IMAGE -->
                                <img [src]="product.image || 'assets/images/no-image.jpg'" class="product-img" />

                                <!-- INFO -->
                                <div class="product-info">

                                    <h6 class="product-name">{{ product.name }}</h6>

                                    <!-- VENDOR INFO -->
                                    <div class="vendor-info">
                                        <div class="vendor-name">
                                            {{ product.shop?.name }}
                                        </div>

                                        <div class="vendor-address">
                                            {{ product.shop?.address }}
                                        </div>

                                        <div class="vendor-status" *ngIf="!product.shop?.is_accepting_orders">
                                            Not accepting orders
                                        </div>
                                    </div>

                                    <!-- PRICE -->
                                    <div class="price-row">
                                        <span class="price">₹{{ product.final_price }}</span>
                                        <del *ngIf="product.discount_value">₹{{ product.price }}</del>
                                    </div>

                                </div>
                            </a>

                            <!-- ACTIONS -->
                            <div class="product-actions">

                                <button class="btn-add" [disabled]="!product.shop?.is_accepting_orders"
                                    *ngIf="!product.qty" (click)="addToCart(product)">
                                    ADD
                                </button>

                                <!-- QTY -->
                                <div *ngIf="product.qty" class="qty-box">
                                    <button (click)="decreaseQty(product)">−</button>
                                    <span>{{ product.qty }}</span>
                                    <button (click)="increaseQty(product)">+</button>
                                </div>


                                <button class="btn-subscribe" (click)="openSubscribeModal(product)">
                                    Subscribe
                                </button>

                            </div>

                        </div>
                    </div>


                    <!-- NO PRODUCTS -->
                    <ng-template #noProducts>
                        <div class="empty">
                            No products found
                        </div>
                    </ng-template>

                </section>

            </div>
        </div>
    </div>

    <ng-template #subscribeModal let-modal>
    <div class="p-4">
      <!-- Header -->
      <h5 class="mb-3">Subscribe to Product</h5>

      <!-- Product Info -->
      <div class="d-flex align-items-center mb-3">
        <img [src]="selectedProduct?.image || 'assets/images/no-image.jpg'" alt="Product Image"
          style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px;" />

        <div class="flex-grow-1 subscribe-product-name">
          <div class="fw-bold">{{ selectedProduct?.name }}</div>
          <div class="text-muted">Unit: {{selectedProduct?.unit.code}}</div>
          <div class="text-muted small">₹{{ selectedProduct?.final_price }}</div>
        </div>

        <!-- Qty Controls -->
        <div class="quantity-box d-flex align-items-center border rounded px-2 py-1"
          style="width: fit-content; height: 38px;">
          <button class="qty-btn" (click)="decreaseQty(selectedProduct)">−</button>
          <input type="number" [(ngModel)]="selectedProduct.qty"
            (ngModelChange)="selectedProduct.qty = selectedProduct.qty < 1 ? 1 : selectedProduct.qty"
            class="qty-input mx-2" style="width: 50px; text-align: center; border: none; outline: none; height: 100%;"
            min="1" />
          <button class="qty-btn" (click)="increaseQty(selectedProduct)">+</button>
        </div>
      </div>

      <!-- Subscription Options -->
      <div class="mb-3">
        <div class="form-floating mb-3">
          <select class="form-select form-select-sm" [(ngModel)]="subscriptionPlan" id="subscription-select">
            <option value="daily">Daily</option>
            <option value="alternate_day">Alternate Day</option>
            <option value="every_3_days">Every 3 Days</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <label for="subscription-select">Pick a Schedule</label>
        </div>
        <div class="form-floating mb-3">
          <input type="date" [(ngModel)]="startDate" class="form-control form-control-sm mt-2"
            placeholder="Pick a Start date" id="schedule-date" />
          <label for="schedule-date">Pick a start date</label>
        </div>
      </div>

      <!-- Terms -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Terms & Conditions</label>
        <p class="small text-muted mb-0">
          • You can cancel or reschedule your subscription at any time.<br />
          • Minimum commitment of 7 days is required.<br />
          • Delivery will be paused on public holidays.
        </p>
      </div>

      <!-- Footer -->
      <div class="text-end">
        <button class="btn btn-secondary btn-sm me-2" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-success btn-sm" (click)="confirmSubscription()">Confirm</button>
      </div>
    </div>
  </ng-template>
</div>