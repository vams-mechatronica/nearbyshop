<div class="container-fluid py-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'profile'"
              (click)="setActiveTab('profile')">
              <i class="fa-solid fa-user me-2"></i> Profile Details
            </button>

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'orders'"
              (click)="setActiveTab('orders')">
              <i class="fa-solid fa-box me-2"></i> Order History
            </button>

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'transactions'"
              (click)="setActiveTab('transactions')">
              <i class="fa-solid fa-credit-card me-2"></i> Transactions
            </button>

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'subscriptions'"
              (click)="setActiveTab('subscriptions')">
              <i class="fa-solid fa-file-contract me-2"></i> Subscriptions
            </button>

            <!-- <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'cart'"
              (click)="setActiveTab('cart')">
              <i class="fa-solid fa-cart-shopping me-2"></i> Cart
            </button> -->

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'wallet'"
              (click)="setActiveTab('wallet')">
              <i class="fa-solid fa-wallet me-2"></i> Wallet
            </button>

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'bank'"
              (click)="setActiveTab('bank')">
              <i class="fa-solid fa-building-columns me-2"></i> Bank Details
            </button>

            <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'refunds'"
              (click)="setActiveTab('refunds')">
              <i class="fa-solid fa-rotate-left me-2"></i> Refund History
            </button>

            <!-- <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'tracking'"
              (click)="setActiveTab('tracking')">
              <i class="fa-solid fa-truck me-2"></i> Order Tracking
            </button> -->
          </div>

        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="col-md-9">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body">
          <!-- Profile -->
          <div *ngIf="activeTab === 'profile'">
            <h4 class="mb-3">Profile Details</h4>
            <div class="row">
              <div class="col-md-6 mb-2"><strong>Name:</strong> {{user.username}}</div>
              <div class="col-md-6 mb-2"><strong>Email:</strong> {{user.email}}</div>
              <div class="col-md-6 mb-2"><strong>Phone:</strong> {{user.phone_number}}</div>
              <div class="col-md-6 mb-2"><strong>Role:</strong> {{user.role}}</div>
            </div>
          </div>

          <!-- Orders -->
          <div *ngIf="activeTab === 'orders'">
            <h4 class="mb-3">Order History</h4>

            <div class="row g-3">
              <div class="col-md-4" *ngFor="let order of orders">
                <div class="card h-100 shadow-sm" (click)="openOrderItems(order)">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h5 class="card-title mb-0">Order #{{ order.id }}</h5>
                      <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">
                        {{ order.status }}
                      </span>
                    </div>
                    <p class="card-text mb-1">Date: {{ order.created_at | date }}</p>
                    <p class="card-text mb-1">Total: ₹{{ order.total_price }}</p>
                  </div>
                </div>
              </div>

            </div>
          </div>


          <!-- Transactions -->
          <div *ngIf="activeTab === 'transactions'">
            <h4 class="mb-3">Transaction History</h4>
            <ag-grid-angular class="ag-theme-alpine w-100" [rowData]="transactions" [columnDefs]="txnCols"
              style="height: 400px">
            </ag-grid-angular>
          </div>

          <!-- Subscriptions -->
          <div *ngIf="activeTab === 'subscriptions'">
            <h4 class="mb-3">Subscriptions</h4>

            <div class="row g-3">
              <div class="col-md-4" *ngFor="let sub of subscriptions">
                <div class="card h-100 shadow-sm position-relative">
                  <!-- Badge in top-right corner -->
                  <span class="badge position-absolute top-0 end-0 m-2"
                    [ngClass]="getSubscriptionBadgeClass(sub.status)">
                    {{ sub.status }}
                  </span>

                  <div class="card-body">
                    <h5 class="card-title">{{ sub.product.name }}</h5>
                    <p class="card-text mb-1">Start: {{ sub.start_date | date }}</p>
                    <p class="card-text mb-1">End: {{ sub.end_date | date }}</p>
                    <p class="card-text mb-1">Price: ₹{{ sub.price }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Wallet -->
          <div *ngIf="activeTab === 'wallet'">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Wallet</h4>
              <button class="btn btn-sm primary" (click)="openAddFundsModal()">
                Add Funds
              </button>
            </div>
            <p><strong>Balance:</strong> ₹{{ wallet.balance }}</p>
          </div>


          <!-- Bank -->
          <div *ngIf="activeTab === 'bank'" class="position-relative">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Bank Details</h4>
              <button class="btn btn-sm primary" (click)="openBankModal()">
                {{ bank?.bank_name ? 'Edit' : 'Add' }} Bank
              </button>
            </div>
            <ng-container *ngIf="bank?.bank_name; else noBank">
              <p><strong>Bank:</strong> {{bank.bank_name}}</p>
              <p><strong>Account No:</strong> {{bank.account_number}}</p>
              <p><strong>IFSC:</strong> {{bank.ifsc_code}}</p>
            </ng-container>
            <ng-template #noBank>
              <p class="text-muted">No bank details added yet.</p>
            </ng-template>
          </div>

          <!-- Bank Modal -->
          <div class="modal fade show" tabindex="-1" *ngIf="showBankModal"
            style="display:block; background: rgba(0,0,0,0.6);" (click)="closeBankModal()">
            <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">{{ bank?.bankName ? 'Edit' : 'Add' }} Bank Details</h5>
                  <button type="button" class="btn-close" (click)="closeBankModal()"></button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label for="bankName" class="form-label">Bank Name</label>
                      <input id="bankName" type="text" class="form-control" [(ngModel)]="bankForm.bank_name"
                        name="bankName" placeholder="Enter bank name">
                    </div>
                    <div class="mb-3">
                      <label for="accountHolderName" class="form-label">Account Holder Name</label>
                      <input id="accountHolderName" type="text" class="form-control"
                        [(ngModel)]="bankForm.account_holder_name" name="accountHolderName"
                        placeholder="Enter account holder name">
                    </div>
                    <div class="mb-3">
                      <label for="accountNumber" class="form-label">Account Number</label>
                      <input id="accountNumber" type="text" class="form-control" [(ngModel)]="bankForm.account_number"
                        name="accountNumber" placeholder="Enter account number">
                    </div>
                    <div class="mb-3">
                      <label for="ifsc" class="form-label">IFSC Code</label>
                      <input id="ifsc" type="text" class="form-control" [(ngModel)]="bankForm.ifsc_code" name="ifsc"
                        placeholder="Enter IFSC code">
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" (click)="closeBankModal()">Cancel</button>
                  <button class="btn btn-success" (click)="saveBankDetails()">Save</button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="activeTab === 'refunds'">
            <h4 class="mb-3">Refund History</h4>
            <ag-grid-angular class="ag-theme-alpine w-100" [rowData]="refunds" [columnDefs]="refundCols"
              style="height: 400px">
            </ag-grid-angular>
          </div>
        </div>
        <!-- <div *ngIf="activeTab === 'bank'">
          <h4 class="mb-3">Bank Details</h4>
          <p><strong>Bank:</strong> {{bank.bankName}}</p>
          <p><strong>Account No:</strong> {{bank.accountNumber}}</p>
          <p><strong>IFSC:</strong> {{bank.ifsc}}</p>
        </div> -->

        <!-- Refunds -->


        <!-- Tracking -->
        <!-- <div *ngIf="activeTab === 'tracking'">
          <h4 class="mb-3">Order Tracking</h4>
          <div *ngFor="let track of tracking" class="mb-2">
            <div class="p-2 border rounded">
              <strong>Order #{{track.orderId}}</strong> - {{track.status}} ({{track.updated}})
            </div>
          </div>
        </div> -->
      </div>
    </div>
  </div>
</div>

<!-- Add Funds Modal -->
<div class="modal fade show" tabindex="-1" *ngIf="showAddFundsModal" style="display:block; background: rgba(0,0,0,0.6);"
  (click)="closeAddFundsModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Funds</h5>
        <button type="button" class="btn-close" (click)="closeAddFundsModal()"></button>
      </div>
      <div class="modal-body">
        <label for="amount" class="form-label">Enter Amount</label>
        <input id="amount" type="number" class="form-control" [(ngModel)]="amount" placeholder="Enter amount">
        <div class="mt-3">
          <button type="button" class="btn btn-outline-primary me-2 mb-2"
            *ngFor="let amt of [100,200,500,1000,2000,5000]" (click)="setRechargeAmount(amt)">
            ₹{{ amt }}
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddFundsModal()">Cancel</button>
        <button class="btn btn-success" (click)="rechargeNow()" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          {{ loading ? 'Processing...' : 'Recharge Now' }}
        </button>

      </div>
    </div>
  </div>
</div>

<ng-template #orderItemsModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Order #{{ selectedOrder?.id }} Items</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <ul class="list-group">
      <li class="list-group-item" *ngFor="let item of selectedOrder?.items">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <!-- Product image -->
            <img [src]="item.image" alt="{{ item.product }}" width="30" height="30" class="me-2 rounded">

            <!-- Product name and quantity -->
            <div>
              <strong>{{ item.product }}</strong>
              <div class="text-muted small">Qty: {{ item.quantity }}</div>
            </div>
          </div>

          <!-- Price -->
          <span>₹{{ item.price }}</span>
        </div>

      </li>
    </ul>
  </div>
</ng-template>