<div class="container-body">

  <div class="shop-page">

    <!-- BREADCRUMBS -->
    <nav class="breadcrumbs">
      <span routerLink="/">Home</span>
      <span>/</span>
      <span routerLink="/shop">Shop</span>
      <span>/</span>
      <span class="active">{{ categoryName }}</span>
    </nav>

    <div class="shop-layout">

      <!-- CATEGORY SIDEBAR -->
      <aside class="category-sidebar" [class.open]="showCategories">

        <!-- MOBILE HEADER -->
        <div class="sidebar-header mobile-only">
          <h6>Categories</h6>
          <button class="close-btn" (click)="showCategories = false">✕</button>
        </div>

        <ul class="category-list">
          <li *ngFor="let category of categories" (click)="onCategoryChange(category.slug); showCategories = false"
            [class.active]="category.slug === categoryName">
            <span>{{ category.name }}</span>
            <!-- <small>{{ category.count }}</small> -->
          </li>
        </ul>

      </aside>


      <!-- PRODUCT AREA -->
      <section class="product-area" #productScroller (scroll)="onProductScroll()">

        <!-- MOBILE CATEGORY TOGGLE -->
        <button class="mobile-filter-btn" (click)="showCategories = true">
          <i class="fas fa-list"></i>
          Categories
        </button>

        <!-- LOADER -->
        <div class="product-loader" *ngIf="isLoading">
          <div class="spinner-border text-danger"></div>
        </div>


        <!-- GRID -->
        <div class="product-grid" *ngIf="products.length; else noProducts">
          <div class="product-card" *ngFor="let product of products"
            [class.vendor-closed]="!product.vendor?.is_accepting_orders">

            <a [routerLink]="['/product', product.slug]">

              <!-- DISCOUNT -->
              <div *ngIf="product.discount_value > 0" class="discount-badge">
                {{ product.discount_type === 'percentage'
                ? (product.discount_value | number:'1.0-0') + '% OFF'
                : '₹' + (product.discount_value | number:'1.0-0') + ' OFF' }}
              </div>

              <!-- IMAGE -->
              <img [src]="product.image" class="product-img" />

              <!-- INFO -->
              <div class="product-info">
                <h6 class="product-title">{{ product.name }}</h6>

                <!-- VENDOR INFO -->
                <div class="vendor-info">
                  <span class="vendor-name">
                    {{ product.vendor?.shop_name }}
                  </span>
                  <span class="vendor-address">
                    {{ product.vendor?.shop_address }}
                  </span>
                </div>

                <!-- PRICE -->
                <div class="price-row">
                  <span class="price">₹{{ product.final_price }}</span>
                  <del *ngIf="product.discount_value">₹{{ product.price }}</del>
                  <span class="unit">{{ product.unit.code }}</span>
                </div>
              </div>
            </a>

            <div class="product-actions">

              <!-- CART ACTION -->
              <div class="cart-action">
                <!-- ADD TO CART -->
                <button class="btn-add" [class.hidden]="product.qty" [disabled]="!product.vendor?.is_accepting_orders"
                  (click)="addToCart(product)">
                  ADD
                </button>

                <!-- QTY -->
                <div class="qty-box" [class.visible]="product.qty">
                  <button (click)="decreaseQty(product)">−</button>
                  <span>{{ product.qty }}</span>
                  <button (click)="increaseQty(product)">+</button>
                </div>
              </div>

              <!-- SUBSCRIBE -->
              <button class="btn-subscribe" (click)="openSubscribeModal(product)">
                Subscribe
              </button>

            </div>


            <!-- CLOSED LABEL -->
            <div class="closed-overlay" *ngIf="!product.vendor?.is_accepting_orders">
              Not accepting orders
            </div>

          </div>

        </div>

        <!-- EMPTY -->
        <ng-template #noProducts>
          <div class="empty-state">
            No products found
          </div>
        </ng-template>

      </section>
    </div>

  </div>


  <ng-template #subscribeModal let-modal>
    <div class="p-4">
      <!-- Header -->
      <h5 class="mb-3">Subscribe to Product</h5>

      <!-- Product Info -->
      <div class="d-flex align-items-center mb-3">
        <img [src]="selectedProduct?.image" alt="Product Image"
          style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px;" />

        <div class="flex-grow-1">
          <div class="fw-bold">{{ selectedProduct?.name }} <span>({{selectedProduct?.unit.code}})</span></div>
          <div class="text-muted small">₹{{ selectedProduct?.final_price }}</div>
        </div>

        <!-- Qty Controls -->
        <div class="quantity-box d-flex align-items-center border rounded px-2 py-1"
          style="width: fit-content; height: 38px;">
          <button class="qty-btn" (click)="decreaseQty(selectedProduct)">−</button>
          <input type="number" [(ngModel)]="selectedProduct.qty"
            (ngModelChange)="selectedProduct.qty = selectedProduct.qty < 1 ? 1 : selectedProduct.qty"
            class="qty-input mx-2" style="width: 50px; text-align: center; border: none; outline: none; height: 100%;"
            min="1" />
          <button class="qty-btn" (click)="increaseQty(selectedProduct)">+</button>
        </div>
      </div>

      <!-- Subscription Options -->
      <div class="mb-3">
        <div class="form-floating mb-3">
          <select class="form-select form-select-sm" [(ngModel)]="subscriptionPlan" id="subscription-select">
            <option value="daily">Daily</option>
            <option value="alternate_day">Alternate Day</option>
            <option value="every_3_days">Every 3 Days</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <label for="subscription-select">Pick a Schedule</label>
        </div>
        <div class="form-floating mb-3">
          <input type="date" [(ngModel)]="startDate" class="form-control form-control-sm mt-2"
            placeholder="Pick a Start date" id="schedule-date" />
          <label for="schedule-date">Pick a start date</label>
        </div>
      </div>

      <!-- Terms -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Terms & Conditions</label>
        <p class="small text-muted mb-0">
          • You can cancel or reschedule your subscription at any time.<br />
          • Minimum commitment of 7 days is required.<br />
          • Delivery will be paused on public holidays.
        </p>
      </div>

      <!-- Footer -->
      <div class="text-end">
        <button class="btn btn-secondary btn-sm me-2" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-success btn-sm" (click)="confirmSubscription()">Confirm</button>
      </div>
    </div>
  </ng-template>
</div>