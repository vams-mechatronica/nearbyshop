<ng-template #subscribeModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Edit Subscription</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <!-- Product Info -->
    <div class="d-flex align-items-center mb-3" *ngIf="selectedSubscription">
      <img [src]="selectedSubscription.product.image" alt="Product Image" class="rounded me-3"
        style="width: 100px; height: 60px; object-fit: cover;" />
      <div class="flex-grow-1">
        <div class="fw-bold">{{ selectedSubscription.product.name }}</div>
        <div class="text-muted small">â‚¹{{ selectedSubscription.product.price }}</div>
      </div>
      <div class="quantity-box-sub d-flex align-items-center border rounded px-2 py-1">
        <button class="btn btn-sm btn-light" (click)="decreaseQty()">âˆ’</button>
        <input type="number" [(ngModel)]="selectedSubscription.quantity"
          class="form-control form-control-sm text-center mx-2" style="width: 60px;" min="1" />
        <button class="btn btn-sm btn-light" (click)="increaseQty()">+</button>
      </div>
    </div>

    <!-- Subscription Options -->
    <div class="form-floating mb-3">
      <select class="form-select" [(ngModel)]="subscriptionPlan" id="subscription-select">
        <option value="daily">Daily</option>
        <option value="alternate_day">Alternate Day</option>
        <option value="every_3_days">Every 3 Days</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Biweekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <label for="subscription-select">Pick a Schedule</label>
    </div>
    <div class="form-floating mb-3">
      <input type="date" [(ngModel)]="startDate" class="form-control" id="schedule-date" />
      <label for="schedule-date">Pick a start date</label>
    </div>
    <div class="form-floating mb-3">
      <select class="form-select" [(ngModel)]="subscriptionStatus" id="status-select">
        <option value="active">Active</option>
        <option value="paused">Paused</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <label for="status-select">Subscription Status</label>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="modal.dismiss()">Cancel</button>
    <button class="btn btn-success btn-sm" (click)="confirmSubscription()">Save</button>
  </div>
</ng-template>

<div class="container mt-4">
  <!-- Wallet + Address -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="p-3 bg-white rounded shadow-sm h-100 d-flex flex-column justify-content-between align-items-center">
        <div class="text-center">
          <h6>Wallet Balance</h6>
          <span class="fw-bold display-6 d-block">â‚¹{{ walletBalance | number:'1.2-2' }}</span>
        </div>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-primary" (click)="openAddFundsModal()">
            Add Funds
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="p-3 bg-white rounded shadow-sm h-100">
        <h5 class="fw-bold mb-2">Delivery Address</h5>
        <p class="mb-0">
          {{ selectedAddress.name }}<br />
          {{ selectedAddress.address_line }}<br />
          {{ selectedAddress.city }}, {{ selectedAddress.state }} - {{ selectedAddress.zip_code }}<br />
          ðŸ“ž {{ selectedAddress.phone_number }}
        </p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item" *ngFor="let tab of ['active','paused','cancelled','expired']">
      <button class="nav-link" [class.active]="activeSubTab === tab" (click)="activeSubTab = tab">
        {{ tab | titlecase }}
      </button>
    </li>
  </ul>

  <!-- Subscription List -->
  <div class="subscriptions-container mb-4" style="max-height: 400px; overflow-y: auto;">
    <div *ngFor="let sub of subscriptions | subFilter:activeSubTab"
      class="d-flex align-items-center p-3 border-bottom bg-white rounded mb-2 shadow-sm">
      <img [src]="sub.product.image" class="product-thumb me-3" alt="{{ sub.product.name }}" />
      <div class="flex-grow-1">
        <h6 class="fw-bold mb-1">{{ sub.product.name }}</h6>
        <p class="text-muted small mb-1">Qty: {{ sub.quantity }}</p>
        <p class="text-muted small mb-1">Frequency: {{ sub.frequency | titlecase }}</p>
        <p class="text-muted small mb-1">Status: {{ sub.status | titlecase }}</p>
        <span class="fw-bold">â‚¹{{ sub.price }}</span>
      </div>
      <div class="ms-3 d-flex justify-content-end gap-2">
        <button class="btn btn-sm btn-secondary" (click)="openSubscribeModal(sub, subscribeModal)">
          Edit
        </button>
        <button *ngIf="sub.status === 'active'" class="btn btn-sm btn-danger" (click)="pauseSubscription(sub)">
          Pause
        </button>

        <button *ngIf="sub.status === 'paused'" class="btn btn-sm btn-success" (click)="activateSubscription(sub)">
          Activate
        </button>

      </div>

    </div>
  </div>
</div>

<!-- Add Funds Modal -->
<div class="modal fade show" tabindex="-1" *ngIf="showAddFundsModal" style="display:block; background: rgba(0,0,0,0.6);"
  (click)="closeAddFundsModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Funds</h5>
        <button type="button" class="btn-close" (click)="closeAddFundsModal()"></button>
      </div>
      <div class="modal-body">
        <label for="amount" class="form-label">Enter Amount</label>
        <input id="amount" type="number" class="form-control" [(ngModel)]="amount" placeholder="Enter amount">
        <div class="mt-3">
          <button type="button" class="btn btn-outline-primary me-2 mb-2"
            *ngFor="let amt of [100,200,500,1000,2000,5000]" (click)="setRechargeAmount(amt)">
            â‚¹{{ amt }}
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddFundsModal()">Cancel</button>
        <button class="btn btn-success" (click)="rechargeNow()">Recharge Now</button>
      </div>
    </div>
  </div>
</div>